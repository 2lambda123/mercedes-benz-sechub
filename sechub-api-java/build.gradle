// SPDX-License-Identifier: MIT
 /*============================================================================
 * Build file for subproject sechub-api-java
 *
 * Root build file: "${rootProject.projectDir}/build.gradle"
 * ============================================================================
 */

ext {
    jersey_version = "2.35"
    jackson_version = "2.13.2"
    jackson_databind_version = "2.13.2.2"
    jackson_databind_nullable_version = "0.2.3"
}

dependencies {
    // The production code uses the SLF4J logging API at compile time
    implementation spring_boot_dependency.slf4j_api
    implementation spring_boot_dependency.jackson_core
    implementation spring_boot_dependency.jackson_databind
    
    implementation project(':sechub-commons-model')
    
    implementation library.apache_httpcomponents_client

    testImplementation spring_boot_dependency.junit_jupiter

    testImplementation spring_boot_dependency.mockito_core
    testImplementation library.mockito_inline
    testImplementation spring_boot_dependency.hamcrest

    implementation library.jcommander
    implementation spring_boot_dependency.logback_classic
    implementation "org.glassfish.jersey.core:jersey-client:$jersey_version"
    implementation "org.glassfish.jersey.inject:jersey-hk2:$jersey_version"
    implementation "org.glassfish.jersey.media:jersey-media-multipart:$jersey_version"
    implementation "org.glassfish.jersey.media:jersey-media-json-jackson:$jersey_version"
    implementation "org.glassfish.jersey.connectors:jersey-apache-connector:$jersey_version"
    implementation "com.fasterxml.jackson.core:jackson-core:$jackson_version"
    implementation "com.fasterxml.jackson.core:jackson-annotations:$jackson_version"
    implementation "com.fasterxml.jackson.core:jackson-databind:$jackson_databind_version"
    implementation "com.fasterxml.jackson.datatype:jackson-datatype-jsr310:$jackson_version"
    implementation "org.openapitools:jackson-databind-nullable:$jackson_databind_nullable_version"
    implementation files('gen/build/libs/sechub-api-java-0.0.0.jar')
}

// see https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator-gradle-plugin/README.adoc
apply plugin: 'org.openapi.generator'

def specFilePath = "$rootDir/sechub-doc/build/api-spec/openapi3.json"

openApiValidate {
    inputSpec = "$specFilePath"
}

// For details about GeneratorTask options look at
// https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator-gradle-plugin
task callOpenAPIJavaGenerator(type: org.openapitools.generator.gradle.plugin.tasks.GenerateTask) {
    generatorName = "java"
    
    inputSpec = "$specFilePath"
    outputDir = "$rootDir/sechub-api-java/gen"
    apiPackage = "com.mercedesbenz.sechub.api.java"
    invokerPackage = "com.mercedesbenz.sechub.api.java"
    modelPackage = "com.mercedesbenz.sechub.api.java.model"
    
    globalProperties = [
            validateSpec   : "true",
            modelDocs      : "false",
            models         : "",  // generate all
            apis           : "", // generate all
            supportingFiles: ""  // generate all
    ]
    // java generator: https://github.com/OpenAPITools/openapi-generator/blob/master/docs/generators/java.md
    configOptions = [
    		groupId 					: "com.mercedesbenz.sechub",
    		version                     : "${project.version}",
            performBeanValidation		: "false",
            useBeanValidation    		: "false",
            java8                		: "true",
            dateLibrary          		: "java8",
            serializableModel    		: "true",
            serializationLibrary 		: "jackson",
            artifactId           		: "sechub-api-java",
            artifactDescription			: "The SecHub API library for Java",
            artifactUrl					: "https://github.com/mercedes-benz/sechub",
            legacyDiscriminatorBehavior : "false",
            library 					: "jersey2",
            licenseName 				: "MIT",
            licenseUrl					: "https://github.com/mercedes-benz/sechub/blob/develop/LICENSE",
            developerEmail				: "",
            developerName				: "",
            developerOrganization 		: "Daimler TSS",
            developerOrganizationUrl	: "https://www.daimler-tss.com/",
            scmConnection				: "",
            scmDeveloperConnection		: "",
            scmUrl						: "https://github.com/mercedes-benz/sechub"
    ]

	doFirst {
        //cleanup openapi gen folder if present
        delete fileTree ( dir: outputDir )
    }
}

tasks.withType(org.openapitools.generator.gradle.plugin.tasks.GenerateTask) {
    outputs.upToDateWhen { false }
    outputs.cacheIf { false }
}

ext.apiPublishNecessary = "${project.version}" != "0.0.0";

task buildAPIJava(type:Exec, dependsOn: 'generateAPIJava') {
  group 'sechub'
  description 'This builds only the generated SecHub Java Client'
  dependsOn 'generateAPIJava'
  
  workingDir = "${project.projectDir}"    

  commandLine './generateAPI.sh', "${workingDir}/gen", "${apiPublishNecessary}"
}

task generateAPIJava(dependsOn: callOpenAPIJavaGenerator){
    doLast {
        
        def generatedGradleFile = new File("${rootProject.projectDir}/sechub-api-java/gen/build.gradle")
        
        StringBuilder sb = new StringBuilder();
        sb.append("/** add custom publishing parts:*/\n");
        sb.append("ext.apiPublishNecessary=${apiPublishNecessary}\n");
        sb.append("ext.buildDoneByGitHubActions=${buildDoneByGitHubActions}\n");
        sb.append("apply from: \"${rootProject.projectDir}/sechub-api-java/build-publish-github-packages.gradle\"");
        
        generatedGradleFile.append("\n"+sb.toString());
    }
}

task buildOpenAPITestTool(type: Jar, dependsOn: build) {
    group 'sechub'
    description 'Builds the SecHub Open API CLI test tool.'
    archiveBaseName = 'sechub-OpenAPI-TestTool'

    manifest {
        attributes 'Main-Class': 'com.mercedesbenz.sechub.api.java.demo.cli.OpenAPITestTool'
    }

    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    duplicatesStrategy = DuplicatesStrategy.INCLUDE
    with jar
}
